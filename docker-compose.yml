version: "3.8"

services:
  kafka:
    image: confluentinc/cp-kafka:7.5.3
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_NUM_PARTITIONS: 1
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/9092'"]
      interval: 10s
      timeout: 5s
      retries: 10

  kafka-init:
    image: confluentinc/cp-kafka:7.5.3
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: ["/bin/bash"]
    command:
      - "-ec"
      - |
        for i in $(seq 1 30); do
          /usr/bin/kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic items-events --partitions 1 --replication-factor 1 && break
          echo 'waiting for kafka topic provisioning...'
          sleep 2
        done
        /usr/bin/kafka-topics --bootstrap-server kafka:9092 --describe --topic items-events
        touch /tmp/topic-ready
        echo 'kafka-init complete; keeping container alive for CI compose --abort-on-container-exit mode'
        tail -f /dev/null
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/topic-ready"]
      interval: 5s
      timeout: 3s
      retries: 20

  auth-service:
    build: ./backend/auth-service
    ports:
      - "4000:4000"
    environment:
      AUTH_SECRET_KEY: auth-secret-key
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:4000/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 10

  item-service:
    build: ./backend/item-service
    ports:
      - "5000:5000"
    environment:
      AUTH_SECRET_KEY: auth-secret-key
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC: items-events
    depends_on:
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5000/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 10

  item-read-service:
    build: ./backend/item-read-service
    ports:
      - "6000:6000"
    depends_on:
      kafka-init:
        condition: service_healthy
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC: items-events
      SQLITE_DB_PATH: /data/items_read.db
    volumes:
      - read-db:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:6000/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 10

  item-writer-service:
    build: ./backend/item-writer-service
    environment:
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC: items-events
      SQLITE_DB_PATH: /data/items_read.db
    depends_on:
      kafka-init:
        condition: service_healthy
    volumes:
      - read-db:/data

  gateway:
    build: ./backend/gateway-service
    ports:
      - "8080:8080"
    environment:
      AUTH_SERVICE_URL: http://auth-service:4000
      ITEM_SERVICE_URL: http://item-service:5000
      ITEM_READ_SERVICE_URL: http://item-read-service:6000
    depends_on:
      auth-service:
        condition: service_healthy
      item-service:
        condition: service_healthy
      item-read-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/auth/health > /dev/null"]
      interval: 10s
      timeout: 5s
      retries: 10

  qa-tests:
    build: ./qa-tests
    environment:
      KARATE_ENV: docker
      BASE_URL: http://gateway:8080
    volumes:
      - read-db:/data
    depends_on:
      gateway:
        condition: service_healthy
      kafka:
        condition: service_healthy
      kafka-init:
        condition: service_healthy

volumes:
  read-db:
